---
- name: 
  hosts:
    - game-k3s-managers
  run_once: true
  tags:
    - server
  environment:
    KUBECONFIG: "{{ kube_config_path }}"
  become: true
  vars:
    network_address: "10.0.206.100"
    instance: "vault-hunters"
    itzg_tag: "java21"
    namespace: "games"
    version: "v3.19.4.0"
    min_cpu: 2
    max_cpu: 4
    min_ram: "8G"
    max_ram: "20G"
    world_size: "20Gi"
    etc_size: "5Gi"
    backup_size: "10Gi"
    save_size: "5Gi"
    mods_size: "5Gi"
    server_stats: "forge"
    svc_port: 25565
    ops_json:
      [
        {
          "uuid": "f0992df2-357c-403c-9d4c-b73da406aabb",
          "name": "queen_of_wands",
          "level": 4,
          "bypassesPlayerLimit": true
        },
        {
          "uuid": "43576037-51ad-4c44-83ff-c741500d8e1e",
          "name": "Mylf_Hunter69420",
          "level": 4
        }
      ]
    envConfigMap:
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: "{{ instance }}-env-{{ version }}"
        namespace: "{{ namespace }}"
        labels:
          app: "{{ instance }}"
          game: minecraft
      data:
        EULA: "true"
        LOG_TIMESTAMP: "true"
        ENABLE_AUTO_RESTART: "false"
        VERSION: "1.18.2"
        TYPE: "AUTO_CURSEFORGE"
        # SEED: ""
        SPAWN_PROTECTION: "0"
        ALLOW_FLIGHT: "TRUE"
        MOTD: "{{ instance }} {{ version }}"
        # RCON_CMDS_STARTUP: |
        #  gamerule doInsomnia false
        #  gamrule doFireTick false
        INIT_MEMORY: "{{ min_ram }}"
        MAX_MEMORY: "{{ max_ram }}"
        PROXY: "http://{{ internet_proxy }}"
        FTP_PROXY: "ftp://{{ internet_proxy }}"
        NO_PROXY: "local,10.0.0.0/8"
        CF_SLUG: "vault-hunters-1-18-2"
        CF_FILE_ID: "6818944"
        # CF_BASE_DIR: "/data"
        # CF_SERVER_MOD: ""
        # GENERIC_PACKS: Vault-Hunters-3rd-Edition-3.19.1.0-server-files
        # GENERIC_PACKS_SUFFIX: .zip
        # GENERIC_PACKS_PREFIX: https://mediafilez.forgecdn.net/files/6807/189/
        SKIP_GENERIC_PACK_UPDATE_CHECK: "false"
        JVM_XX_OPTS: "-XX:+UseZGC -XX:+ParallelRefProcEnabled -XX:+UseStringDeduplication -XX:ParallelGCThreads={{ (min_cpu | int * 2) | round(0, 'ceil') | int }} -XX:+UnlockExperimentalVMOptions -XX:+DisableExplicitGC -XX:+AlwaysPreTouch -XX:+PerfDisableSharedMem"
        USE_AIKAR_FLAGS: "FALSE"
  roles:
    - deploy